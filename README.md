# tg-mt5hub-bot

–ë–æ—Ç-—Ö–∞–± –¥–ª—è —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ —É—á–µ—Ç–∞, –∫–æ–Ω—Ç—Ä–æ–ª—è –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ä–æ–±–æ—Ç–æ–≤ (–±–æ—Ç–æ–≤) –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ MetaTrader 5. –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —Å–≤—è–∑–∫–∏ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –±–æ—Ç–∞–º–∏, —Ä–∞–±–æ—Ç–∞—é—â–∏–º–∏ –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ, –∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:

- —Å–±–æ—Ä —Å–∏–≥–Ω–∞–ª–æ–≤, –±–∞–ª–∞–Ω—Å–æ–≤, —Å—Ç–∞—Ç—É—Å–æ–≤;
- —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ—Ä–≥–æ–≤–ª–µ–π (—Ä–∞–∑—Ä–µ—à–∏—Ç—å/–∑–∞–ø—Ä–µ—Ç–∏—Ç—å);
- –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é –æ—Ç—á—ë—Ç–æ–≤ —á–µ—Ä–µ–∑ Telegram (*–≤ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–µ*)
- HTTP API –¥–ª—è –±–æ—Ç–æ–≤ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ MT5.

---

## üöÄ –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- üõ∞Ô∏è –ü–æ–ª—É—á–µ–Ω–∏–µ heartbeat –∏ —Å–∏–≥–Ω–∞–ª–æ–≤ –æ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –±–æ—Ç–æ–≤ —á–µ—Ä–µ–∑ HTTP
- üí∞ –£—á—ë—Ç –±–∞–ª–∞–Ω—Å–∞ –∏ –ø—Ä–æ—Ñ–∏—Ç–∞ –∫–∞–∂–¥–æ–≥–æ –±–æ—Ç–∞
- üëÆ –ö–æ–Ω—Ç—Ä–æ–ª—å —Ç–æ—Ä–≥–æ–≤–ª–∏: —Ä–∞–∑—Ä–µ—à–∏—Ç—å / –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–æ—Ä–≥–æ–≤–ª—é –Ω–∞ —É—Ä–æ–≤–Ω–µ –±–æ—Ç–∞
- üìä –û—Ç—á—ë—Ç—ã –≤ Telegram —Å –∞–≤—Ç–æ-–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–æ–π –ø–æ –≤—Ä–µ–º–µ–Ω–∏
- üßæ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, —à–∞–±–ª–æ–Ω—ã –Ω–∞ Jinja2, –º–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- üíæ –•—Ä–∞–Ω–∏—Ç —Å—Ç–∞—Ç—É—Å –±–æ—Ç–∞ –∏ –∏—Å—Ç–æ—Ä–∏—é –≤ –ë–î.

---

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

### üîí `.env` ‚Äî —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–§–∞–π–ª `.env` —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:

```
TG_BOT_TOKEN=...          # –¢–æ–∫–µ–Ω Telegram –±–æ—Ç–∞
ROOT_ADMIN_ID=...         # Telegram ID –≥–ª–∞–≤–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
ADMIN_CHAT_ID=...         # –ß–∞—Ç –¥–ª—è –æ—Ç—á–µ—Ç–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
FORWARD_CHAT_IDS=...      # –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ –¥–ª—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç—á–µ—Ç–æ–≤, —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é
MT5_SECRET_KEY=...        # –ö–ª—é—á –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ HMAC-–ø–æ–¥–ø–∏—Å–µ–π –æ—Ç MT5-–±–æ—Ç–æ–≤
BALANCE_API_KEY=...       # –ö–ª—é—á –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ `/api/v1/last_balance`
LOG_LEVEL=DEBUG           # –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è (`DEBUG`, `INFO`, `WARNING`)
```

–°–æ–∑–¥–∞–π `.env` —Ñ–∞–π–ª –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞.

### üìÅ `config/` ‚Äî YAML-—Ñ–∞–π–ª—ã —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏

#### config/ui\_config.yaml

–°–æ–¥–µ—Ä–∂–∏—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–µ–Ω—é –∫–æ–º–∞–Ω–¥ –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ Telegram:

```yaml
telegram_menu:
  - command: allow_trade
    description: "‚ñ∂Ô∏è –†–∞–∑—Ä–µ—à–∏—Ç—å —Ç–æ—Ä–≥–æ–≤–ª—é"
  - command: block_trade
    description: "‚ùå –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–æ—Ä–≥–æ–≤–ª—é"
  ...
```

#### config/auth.yaml

–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ –∫–æ–Ω—Ç—Ä–æ–ª—è –≤—Ä–µ–º–µ–Ω–∏:

```yaml
auth:
  login_mismatch_threshold_sec: 10   # –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–æ–ø—É—Å—Ç–∏–º–∞—è —Ä–∞–∑–Ω–∏—Ü–∞ login
  max_allowed_delay_sec: 60          # –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –±–µ–∑ –ø–∏–Ω–≥–∞
```

#### config/runtime.yaml

–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:

```yaml
bot_runtime:
  message_batch_delay_sec: 5     # –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –ø–∞–∫–µ—Ç–∞ —Å–∏–≥–Ω–∞–ª–æ–≤ –∏–ª–∏ –±–∞–ª–∞–Ω—Å–æ–≤
  heartbeat_timeout_sec: 30      # —Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥ –±–æ—Ç —Å—á–∏—Ç–∞–µ—Ç—Å—è "–≤ —Å–µ—Ç–∏" –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–∏–Ω–≥–∞
  report_delay_sec: 5            # –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π connection report
  bot_ids: [1, 2, 4]             # —Å–ø–∏—Å–æ–∫ ID –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã—Ö –±–æ—Ç–æ–≤
  total_balance_offset: 0.0      # —Å–º–µ—â–µ–Ω–∏–µ —Å—É–º–º—ã –±–∞–ª–∞–Ω—Å–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–∫—Ä—ã—Ç—å —á–∞—Å—Ç—å —Å—É–º–º—ã)
  total_profit_offset: 0.0       # —Å–º–µ—â–µ–Ω–∏–µ –æ–±—â–µ–≥–æ –ø—Ä–æ—Ñ–∏—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–∫—Ä—ã—Ç—å —á–∞—Å—Ç—å –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏)
http_server:
  port: 8080                     # –ø–æ—Ä—Ç —Å–µ—Ä–≤–µ—Ä–∞
```

---

## üõ† –ó–∞–ø—É—Å–∫

1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:

```bash
pip install -r requirements.txt
```

2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `.env` –∏ –∫–æ–Ω—Ñ–∏–≥–∏ –Ω–∞ –º–µ—Å—Ç–µ.
3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞:

```bash
python mt5hub_bot.py
```

---

## üì° HTTP API –¥–ª—è MT5 –±–æ—Ç–æ–≤

### üì§ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ HTTP-–∑–∞–ø—Ä–æ—Å—ã

- `POST /api/v1/bot/heartbeat` ‚Äî –ø–∏–Ω–≥ —Å –¥–∞–Ω–Ω—ã–º–∏
- `POST /api/v1/bot/balance` ‚Äî –ø–µ—Ä–µ–¥–∞—á–∞ –±–∞–ª–∞–Ω—Å–∞/–ø—Ä–æ—Ñ–∏—Ç–∞
- `POST /api/v1/bot/signal` ‚Äî —Å–∏–≥–Ω–∞–ª—ã –ø–æ —Ä—ã–Ω–∫—É

–í—Å–µ –∑–∞–ø—Ä–æ—Å—ã: `POST`, —Ñ–æ—Ä–º–∞—Ç —Ç–µ–ª–∞ ‚Äî JSON.
–ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–∏:

* `x-bot-id`: ID –±–æ—Ç–∞
* `x-mt5-login`: –Ω–æ–º–µ—Ä –ª–æ–≥–∏–Ω–∞
* `x-mt5-time`: UNIX-–≤—Ä–µ–º—è (—Å–µ–∫—É–Ω–¥—ã)
* `x-mt5-signature`: –ø–æ–¥–ø–∏—Å—å HMAC SHA-256


#### 1. `/api/v1/bot/heartbeat`

```json
{
  "broker": "DemoBroker",
  "leverage": 100
}
```

#### 2. `/api/v1/bot/balance`

```json
{
  "balance": 1234.56,
  "profit": -78.90
}
```

#### 3. `/api/v1/bot/signal`

```json
[
  {
    "timestamp": 1717733449000,
    "symbol": "EURUSD",
    "spread": 8,
    "volume": 0.5,
    "direction": 1
  }
]
```

### üì• `GET /api/v1/last_balance` ‚Äî —ç–∫—Å–ø–æ—Ä—Ç –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –±–∞–ª–∞–Ω—Å–∞ –∏ –ø—Ä–æ—Ñ–∏—Ç–∞

–≠—Ç–æ—Ç —ç–Ω–¥–ø–æ–∏–Ω—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è **–ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞–ø–∏—Å–∏** –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –±–∞–ª–∞–Ω—Å–æ–≤ –≤ —Ñ–æ—Ä–º–∞—Ç–µ CSV. –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Google Sheets, Excel –∏ –¥—Ä—É–≥–∏–º–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–º–∏ `IMPORTDATA()`.

–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:

```plaintext
GET /api/v1/last_balance?key=YOUR_SECRET_KEY
```

–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞:

```csv
timestamp,datetime,profit,balance
1717920000,2025-06-09 05:00:00,452.17,10234.65
```

–ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ Google Sheets:

```excel
=IMPORTDATA("https://yourhost/api/v1/last_balance?key=YOUR_SECRET_KEY")
```

> üîê **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è:** —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–µ—Ä–µ–¥–∞—á–∞ `?key=...` ‚Äî –ø—Ä–æ—Å—Ç–æ–π —Å–µ–∫—Ä–µ—Ç, –∑–∞–¥–∞–≤–∞–µ–º—ã–π —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è `BALANCE_API_KEY`.

> ‚ÑπÔ∏è **–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –±–∞–ª–∞–Ω—Å –∏ –ø—Ä–æ—Ñ–∏—Ç –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö —Ç–æ–ª—å–∫–æ –≤ —Ç–æ–º —Å–ª—É—á–∞–µ, –µ—Å–ª–∏ **–≤—Å–µ –±–æ—Ç—ã –Ω–∞—Ö–æ–¥—è—Ç—Å—è –æ–Ω–ª–∞–π–Ω** –≤ –º–æ–º–µ–Ω—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è. –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∏—Å–∫–∞–∂–µ–Ω–∏–µ –æ–±—â–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.


### üîê HMAC-–ø–æ–¥–ø–∏—Å—å

–ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å —Ç–∏–ø–∞ `/api/v1/bot/...` –ø–æ–¥–ø–∏—Å–∞–Ω —á–µ—Ä–µ–∑ HMAC (SHA256) —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –æ–±—â–µ–≥–æ —Å–µ–∫—Ä–µ—Ç–∞ (`MT5_SECRET_KEY`).

```python
def generate_signature(secret: str, bot_id: int, login: int, timestamp: int, body: str) -> str:
    bucket = timestamp // 60
    msg = f"{bot_id}:{login}:{bucket}:{body}".encode()
    return hmac.new(secret.encode(), msg, hashlib.sha256).hexdigest()
```

* `timestamp` –æ–∫—Ä—É–≥–ª—è–µ—Ç—Å—è –¥–æ –º–∏–Ω—É—Ç—ã (`timestamp // 60`) –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è replay-–∞—Ç–∞–∫ –∏ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –≥–∏–±–∫–æ—Å—Ç–∏.
* `body` ‚Äî JSON-—Å—Ç—Ä–æ–∫–∞ –∑–∞–ø—Ä–æ—Å–∞.
* –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –≤ `verify_signature()` –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ.

---

## üìú –õ–∏—Ü–µ–Ω–∑–∏—è

MIT
